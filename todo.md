# FCL 下载站 - 任务清单


## 下一步计划

### 代码优化
- [ ] 合并src/pages/和src/modules/html/目录下的文件
- [ ] 优化JavaScript模块结构
- [ ] 添加TypeScript类型定义
- [ ] 实现代码分割和懒加载
- [ ] 添加单元测试

### UI/UX改进

- [x] 为折叠面板组件添加深色模式支持
- [x] 修复下载页折叠面板使用不规范问题
- [x] 修复下载页折叠面板深色模式边框不可见问题
- [x] 修复下载页折叠面板的子面板点不开问题
- [ ] 添加页面过渡动画
- [ ] 优化移动端触摸体验
- [ ] 改进错误页面设计
- [ ] 添加暗黑模式切换动画

### 功能增强
- [ ] 添加多语言支持
- [ ] 实现用户偏好设置
- [ ] 添加下载历史记录
- [ ] 实现离线访问支持



## 已知问题

- 某些外部资源在开发者模式下被拦截（预期行为）

# 任务列表

## 日志太多
- [x] 确定日志太多的地方
- [x] 加入console.groupCollapsed()

## 公告页配色不正常
- [x] 分析公告页配色问题的具体表现
- [x] 检查玻璃效果与背景颜色的冲突
- [x] 修复公告页配色问题
- [x] 测试修复后的配色效果
- [x] **优化历史公告区域配色方案**
  - [x] 分析历史公告区域看不清的具体问题
  - [x] 检查未应用半透明背景的子面板
  - [x] 优化文字颜色和对比度
  - [x] 测试优化后的可读性

### 修复详情

### 问题分析
历史公告区域中部分子面板仍然使用纯色背景（bg-gray-50），没有应用半透明效果，导致在玻璃效果下文字可读性不佳。

### 修改内容
修复了历史公告区域中以下子面板的背景颜色：
1. **欢迎访问FCL下载站！**子面板：添加`bg-gray-50/80 dark:bg-gray-800/80`和`bg-white/80 dark:bg-gray-900/80`类
2. **PojavLauncher停更**子面板：添加`bg-gray-50/80 dark:bg-gray-800/80`和`bg-white/80 dark:bg-gray-900/80`类  
3. **下载站现状**子面板：添加`bg-gray-50/80 dark:bg-gray-800/80`和`bg-white/80 dark:bg-gray-900/80`类

### 测试结果
修改后历史公告区域配色协调，所有子面板都应用了半透明背景，文字在玻璃效果下具有良好的可读性。



## 问题分析
公告页使用`glass-effect`玻璃效果样式，该样式在深色模式下设置`color: #000`（黑色文字），而公告页内容区域使用`bg-white`（白色背景），导致黑色文字在白色背景上显示且玻璃效果产生视觉冲突。

### 修改内容
1. **移除外层容器白色背景**：将`<div class="bg-white rounded-lg overflow-hidden">`修改为`<div class="rounded-lg overflow-hidden">`
2. **优化玻璃效果样式**：
   - 默认背景从`#00000044`改为`rgba(0, 0, 0, 0.3)`
   - 深色模式下文字颜色从`#000`改为`#fff`
   - 深色模式下背景从`#FFFFFF44`改为`rgba(255, 255, 255, 0.1)`
3. **添加内容区域半透明背景**：为所有公告内容区域添加`bg-white/80 dark:bg-gray-900/80`类
4. **修复面板标题背景**：为所有面板标题添加`bg-gray-50/80 dark:bg-gray-800/80`类

### 测试结果
修改后公告页配色恢复正常，玻璃效果与内容区域协调，文字可读性良好。

## 在所有this.log前加入console.log ✅
- [x] 分析devModeCore.js中所有this.log调用位置
- [x] 在每个this.log调用前添加对应的console.log
- [x] 测试修改后的日志输出功能
- [x] 验证开发者模式日志系统正常工作

**修改详情：**
- 在PerformanceMonitor类的2个this.log调用前添加了console.log
- 在NetworkAnalyzer类的1个this.log调用前添加了console.log  
- 在ErrorCapture类的1个this.log调用前添加了console.log
- 在MemoryMonitor类的1个this.log调用前添加了console.log
- 在DevModeManager类的9个this.log调用前添加了console.log
- 总共在14个this.log调用前添加了对应的console.log输出

**测试结果：** ✅ 功能完全正常，所有日志现在都会同时输出到控制台和开发者模式日志系统

## 统一开发者模式按钮实现详细计划 ✅

**问题分析**：
- 当前项目中存在两个开发者模式按钮：
  1. `dev-mode-toggle`（在devMode.js中创建）：主切换按钮，用于启用/禁用开发者模式
  2. `dev-mode-quick-access`（在devModePanel.js中创建）：快速访问按钮，用于打开开发者面板
- 两个按钮都固定在右下角，位置重叠，造成视觉混乱
- 功能分散，用户体验不佳

**解决方案**：
- 统一使用一个按钮实现所有功能
- 按钮点击行为：
  - 如果开发者模式未启用：点击后启用开发者模式并打开面板
  - 如果开发者模式已启用：点击后打开/关闭面板
- 按钮样式根据状态变化：
  - 禁用状态：灰色背景
  - 启用状态：蓝色背景（与当前quick-access按钮一致）

**实施步骤**：
1. [x] 修改devMode.js，移除dev-mode-toggle按钮创建逻辑
2. [x] 修改devModePanel.js，调整dev-mode-quick-access按钮的行为
3. [x] 更新按钮点击事件处理逻辑
4. [x] 更新按钮样式和状态同步
5. [x] 测试统一后的按钮功能
6. [x] 更新相关文档和注释

**测试结果**：✅ 功能完全正常，按钮状态切换正确，面板开关功能正常

2. **性能优化**
   - 进一步优化页面加载速度
   - 添加资源缓存策略
   - 优化图片加载

3. **用户体验改进**
   - 收集用户反馈
   - 优化界面交互细节
   - 改进错误处理

## 修复开发者模式面板功能
- [x] 添加开发者模式面板关闭功能（禁用开发者模式）
- [x] 实现开发者模式面板拖动功能
- [x] 优化面板用户体验

测试结果：✅ 功能完全正常
- 关闭按钮功能：✅ 点击关闭按钮成功禁用开发者模式，更新URL参数为dev=0，面板正确隐藏
- 拖动功能：✅ 面板支持鼠标和触摸拖动，限制在窗口范围内移动
- 重新启用：✅ 通过主按钮可重新启用开发者模式，URL参数更新为dev=1，面板正确隐藏

## 优化开发者模式核心逻辑
- [x] 提升 `dev=0` 参数优先级，使其高于localhost自动启用
- [x] 优化开发者模式UI，添加禁用按钮
- [x] 修复开发者模式下的网络请求拦截逻辑
- [x] 添加开发者模式状态持久化
- [x] **已修复**：普通用户模式下notification通知显示问题（执行顺序问题）
- [x] **统一开发者模式按钮实现**：当前存在两个按钮（dev-mode-toggle和dev-mode-quick-access），需要统一为一个按钮实现
    - [x] 确认`testAndroidVersion`函数在开发者模式下仍被调用
    - [x] 验证开发者模式不影响userAgent检测
    - [x] 调查为什么开发者模式下缺少"安卓版本检测"日志输出（已解决：普通模式也缺失）
    - [x] 测试notification组件在开发者模式下的实际行为
    - [x] **根本原因**：`testAndroidVersion`和`showDeviceSuggestions`并行执行，存在竞态条件
    - [x] **问题定位**：`testAndroidVersion`依赖`androidVer`变量，但该变量由`showDeviceSuggestions`设置
    - [x] **已修复**：在`main.js`中使用async/await确保执行顺序，在`indexDownLinks.js`中添加延迟执行
  - [x] **已修复**：开发者模式下notification通知显示问题（将自定义showNotification改为使用统一notification通知系统）
  - **测试结果**：✅ 功能完全正常，按钮状态切换正确，面板开关功能正常



## 修复线路选择器为空问题 ✅
- [x] **问题分析**：`populateLineSelection()`在`DOMContentLoaded`时执行，但home.html模块通过异步加载，存在时序问题
- [x] **解决方案**：将`populateLineSelection()`调用延迟500ms执行，确保home.html模块加载完成
- [x] **验证修复**：线路选择器选项已正确填充，setupIndexDownLinks正常调用
- [x] **测试**：所有线路选择功能正常工作，控制台显示智能线路选择初始化成功

## 修复错误状态下切换线路仍然报错问题 ✅
- [x] **问题**：当显示"抱歉，我们遇到了一个无法解决的问题。"错误时，切换线路仍然会报错
- [x] **问题分析**：错误发生后，线路选择器没有被禁用或重置，导致用户切换线路时仍然会触发失败的setupIndexDownLinks()调用
- [x] **解决方案**：在错误处理逻辑中添加线路选择器禁用状态管理
- [x] **修复文件**：src/modules/indexDownLinks.js
- [x] **修复步骤**：
  1. 在错误处理catch块中添加线路选择器禁用逻辑
  2. 在成功执行try块中添加线路选择器启用逻辑
  3. 确保错误状态下线路选择器被禁用，防止用户切换线路
- [x] **验证修复**：错误状态下线路选择器会被禁用，成功状态下会重新启用
- [x] **状态**：已完成

## 替换玻璃设计
- [x] 分析项目中所有玻璃设计元素
- [x] 统一使用新的玻璃设计样式
- [x] 测试玻璃设计在不同组件中的表现
- [x] 验证玻璃设计与项目整体风格一致

## 把所有的alert改成notification通知 ✅
- [x] 分析项目中所有alert使用位置
- [x] 创建通用的notification通知组件(src/utils/notification.js)
- [x] 更新notice.js中的alert为Notification.error
- [x] 更新deviceSuggestions.js中的alert为Notification.warning
- [x] 测试notification组件功能
- [x] 验证notification通知在开发者模式下的行为
- [x] 确认开发者模式会阻止外部请求但不影响userAgent检测
- [x] 测试非开发者模式下notification通知正常工作

## 修复移动端导航栏功能异常 - 替换为桌面端导航栏样式 ✅
- [x] 分析移动端导航栏问题
- [x] 统一使用桌面端导航栏样式
- [x] 优化导航栏响应式设计
- [x] 测试导航栏在各种设备上的表现

## 修复下载功能异常 ✅
- [x] 分析下载链接加载失败原因
- [x] 优化下载链接获取逻辑
- [x] 添加下载失败重试机制
- [x] 改进错误提示信息

## 优化页面加载性能 ✅
- [x] 添加智能线路选择功能
- [x] 优化资源加载顺序
- [x] 添加页面加载状态指示
- [x] 实现下载链接预加载

## 修复设备检测功能 ✅
- [x] 优化设备信息检测逻辑
- [x] 改进系统兼容性判断
- [x] 添加设备建议功能
- [x] 修复Android版本检测逻辑




## 文档完善
- [x] 创建AI更改指南文档（`docs/AI_CHANGE_GUIDE.md`）
  - [x] 包含完整的更改流程和最佳实践
  - [x] 提供常见陷阱和解决方案
  - [x] 详细的测试验证步骤
  - [x] 应急处理方案
- [x] **增强AI更改指南**：补充了36-40行指导原则的缺失内容
  - [x] 添加测试验证环节（功能测试、兼容性测试、性能测试）
  - [x] 明确代码质量要求（错误处理、内存管理、代码风格）
  - [x] 增加版本管理和备份指导
  - [x] 强化性能监控要求
  - [x] 突出用户体验优先原则


## 删除toast.js文件 ✅
- [x] 检查项目中是否还有模块引用toast.js
- [x] 确认所有模块已迁移到notification.js
- [x] 删除toast.js文件
- [x] 更新项目文档

## 从devMode.js提取通用通知组件 ✅
- [x] 分析现有的showDevModeNotification函数实现
- [x] 创建通用的Notification组件
- [x] 更新devMode.js使用新的通用组件
- [x] 创建测试页面(test-notification.html)
- [x] 将Tailwind CSS类替换为内联样式（解决CSS文件加载问题）
- [x] 修复closeAll方法的选择器问题
- [x] 添加调试信息定位问题
- [x] **修复问题**：修复模块导入问题，通知元素现在正常显示
- [x] 测试通知组件功能
- [x] 添加通知堆叠功能（多个通知分行显示）
- [x] **修复堆叠通知显示问题**：修复通知内容超过三行时的堆叠重叠问题
- [x] **增强阴影效果**：增强通知阴影，提升视觉层次感
- [x] UI/UX改进：优化通知动画效果
- [x] 响应式设计：适配移动端显示
- [x] 添加更多通知类型和自定义选项
- [x] 更新项目文档

## 修复堆叠通知显示问题详情
**问题描述：**
- 原堆叠管理器使用固定60px高度计算堆叠偏移，导致通知内容超过三行时出现重叠
- 通知阴影效果太淡，视觉层次感不足

**修复方案：**
1. **动态高度计算：** 将固定60px高度改为动态计算通知实际高度 + 20px间距
2. **阴影增强：** 将阴影值从`0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)`增强为`0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.08)`
3. **高度估算优化：** 添加元素未完全渲染时的高度估算逻辑

**测试验证：**
- 创建test-notification-fix.html测试页面
- 验证短文本、中等长度、长文本通知的堆叠效果
- 测试阴影增强效果
- 验证不同类型通知的显示效果

**结果：**
- 堆叠通知显示正常，无重叠问题
- 阴影效果明显增强，视觉层次感提升
- 通知组件功能完整，响应式设计良好

**问题分析：**
- 当前`devMode.js`中的`showDevModeNotification`函数实现了基本的通知功能
- 功能包括：创建通知元素、设置样式、自动移除、淡入淡出动画
- 项目中已存在`src/utils/notification.js`通知组件，功能完善且被多个模块使用

**当前状态：**
- ✅ 已创建`src/utils/notification.js`通用通知组件
- ✅ 支持多种通知类型（success、warning、error、info）
- ✅ 支持自定义位置、持续时间、动画效果
- ✅ 已更新devMode.js使用新的通知组件
- ✅ 已创建测试页面并添加详细测试功能
- ✅ 已将Tailwind CSS类替换为内联样式（解决CSS文件加载404错误）
- ✅ 已修复closeAll方法的选择器问题
- ✅ 已添加调试信息

**当前问题：**
- 测试页面按钮点击事件正常触发，但通知元素不显示
- 控制台没有显示通知相关的调试日志，说明show方法没有被调用
- 可能的问题：模块导入失败、路径错误、语法错误

**下一步计划：**
1. 检查notification.js文件语法错误
2. 检查测试页面导入路径是否正确
3. 检查模块导入是否成功
4. 添加更多调试信息定位具体问题

**决策：**
- 保持两个通知组件独立，因为：
  - toast组件已被多个模块使用，修改会影响现有功能
  - Notification组件提供更现代的API设计
  - 两个组件可以共存，服务于不同的使用场景


## 修复index.html和main.js的内容加载冲突 ✅
- [x] **问题分析**：index.html中的模块加载脚本和main.js中的DOMContentLoaded事件监听器存在执行顺序冲突
- [x] **问题定位**：main.js在index.html模块加载完成前就执行了DOMContentLoaded事件处理，导致部分功能无法正常工作
- [x] **解决方案**：将main.js的DOMContentLoaded事件监听器改为在模块加载完成后执行
- [x] **实施修复**：修改main.js，使用模块加载完成后的回调来执行初始化逻辑
- [x] **测试验证**：确认所有功能在正确的加载顺序下正常工作

**修改详情：**
- 重构main.js，移除DOMContentLoaded事件监听器，创建initializeApp()函数
- 在index.html中模块加载完成后调用window.initializeApp()
- 添加缺失的智能线路选择器change事件监听器和公告按钮创建功能
- 修复PerformanceMonitor类缺少measure方法的问题

**测试结果：** ✅ 功能完全正常，加载顺序问题已解决
- 控制台日志显示所有模块按正确顺序加载
- 智能线路选择器正常工作，change事件监听器已添加
- 公告按钮正确显示在页面右下角
- 开发者模式面板正常工作，性能监控错误已修复
