# FCL 下载站 - 任务清单

## 高优先级任务

### 修复开发者模式面板功能
- [x] 添加开发者模式面板关闭功能（禁用开发者模式）
- [x] 实现开发者模式面板拖动功能
- [x] 优化面板用户体验

测试结果：✅ 功能完全正常
- 关闭按钮功能：✅ 点击关闭按钮成功禁用开发者模式，更新URL参数为dev=0，面板正确隐藏
- 拖动功能：✅ 面板支持鼠标和触摸拖动，限制在窗口范围内移动
- 重新启用：✅ 通过主按钮可重新启用开发者模式，URL参数更新为dev=1，面板正确显示

### 优化开发者模式核心逻辑
- [x] 提升 `dev=0` 参数优先级，使其高于localhost自动启用
- [x] 优化开发者模式UI，添加禁用按钮
- [x] 修复开发者模式下的网络请求拦截逻辑
- [x] 添加开发者模式状态持久化
- [x] **已修复**：普通用户模式下toast通知显示问题（执行顺序问题）
- [x] **统一开发者模式按钮实现**：当前存在两个按钮（dev-mode-toggle和dev-mode-quick-access），需要统一为一个按钮实现
    - [x] 确认`testAndroidVersion`函数在开发者模式下仍被调用
    - [x] 验证开发者模式不影响userAgent检测
    - [x] 调查为什么开发者模式下缺少"安卓版本检测"日志输出（已解决：普通模式也缺失）
    - [x] 测试toast组件在开发者模式下的实际行为
    - [x] **根本原因**：`testAndroidVersion`和`showDeviceSuggestions`并行执行，存在竞态条件
    - [x] **问题定位**：`testAndroidVersion`依赖`androidVer`变量，但该变量由`showDeviceSuggestions`设置
    - [x] **已修复**：在`main.js`中使用async/await确保执行顺序，在`indexDownLinks.js`中添加延迟执行
  - [x] **已修复**：开发者模式下toast通知显示问题（将自定义showNotification改为使用统一toast通知系统）
  - **测试结果**：✅ 功能完全正常，按钮状态切换正确，面板开关功能正常

### 修复线路选择器为空问题 ✅
- [x] **问题分析**：`populateLineSelection()`在`DOMContentLoaded`时执行，但home.html模块通过异步加载，存在时序问题
- [x] **解决方案**：将`populateLineSelection()`调用延迟500ms执行，确保home.html模块加载完成
- [x] **验证修复**：线路选择器选项已正确填充，setupIndexDownLinks正常调用
- [x] **测试**：所有线路选择功能正常工作，控制台显示智能线路选择初始化成功

## 已完成任务

### 把所有的alert改成toast ✅
- [x] 分析项目中所有alert使用位置
- [x] 创建通用的toast通知组件(src/utils/toast.js)
- [x] 更新notice.js中的alert为showErrorToast
- [x] 更新deviceSuggestions.js中的alert为showWarningToast
- [x] 测试toast组件功能
- [x] 验证toast通知在开发者模式下的行为
- [x] 确认开发者模式会阻止外部请求但不影响userAgent检测
- [x] 测试非开发者模式下toast通知正常工作

### 修复移动端导航栏功能异常 - 替换为桌面端导航栏样式 ✅
- [x] 分析移动端导航栏问题
- [x] 统一使用桌面端导航栏样式
- [x] 优化导航栏响应式设计
- [x] 测试导航栏在各种设备上的表现

### 修复下载功能异常 ✅
- [x] 分析下载链接加载失败原因
- [x] 优化下载链接获取逻辑
- [x] 添加下载失败重试机制
- [x] 改进错误提示信息

### 优化页面加载性能 ✅
- [x] 添加智能线路选择功能
- [x] 优化资源加载顺序
- [x] 添加页面加载状态指示
- [x] 实现下载链接预加载

### 修复设备检测功能 ✅
- [x] 优化设备信息检测逻辑
- [x] 改进系统兼容性判断
- [x] 添加设备建议功能
- [x] 修复Android版本检测逻辑

## 低优先级任务

### 代码优化
- [ ] 优化JavaScript模块结构
- [ ] 添加TypeScript类型定义
- [ ] 实现代码分割和懒加载
- [ ] 添加单元测试

### UI/UX改进
- [ ] 添加页面过渡动画
- [ ] 优化移动端触摸体验
- [ ] 改进错误页面设计
- [ ] 添加暗黑模式切换动画

### 功能增强
- [ ] 添加多语言支持
- [ ] 实现用户偏好设置
- [ ] 添加下载历史记录
- [ ] 实现离线访问支持

## 下一步计划

1. **完成开发者模式优化**
   - 解决设备建议toast通知显示问题
   - 完善开发者模式文档
   - 添加更多开发者工具
   - **统一开发者模式按钮实现**：当前存在两个按钮（dev-mode-toggle和dev-mode-quick-access），需要统一为一个按钮实现

### 统一开发者模式按钮实现详细计划 ✅

**问题分析**：
- 当前项目中存在两个开发者模式按钮：
  1. `dev-mode-toggle`（在devMode.js中创建）：主切换按钮，用于启用/禁用开发者模式
  2. `dev-mode-quick-access`（在devModePanel.js中创建）：快速访问按钮，用于打开开发者面板
- 两个按钮都固定在右下角，位置重叠，造成视觉混乱
- 功能分散，用户体验不佳

**解决方案**：
- 统一使用一个按钮实现所有功能
- 按钮点击行为：
  - 如果开发者模式未启用：点击后启用开发者模式并打开面板
  - 如果开发者模式已启用：点击后打开/关闭面板
- 按钮样式根据状态变化：
  - 禁用状态：灰色背景
  - 启用状态：蓝色背景（与当前quick-access按钮一致）

**实施步骤**：
1. [x] 修改devMode.js，移除dev-mode-toggle按钮创建逻辑
2. [x] 修改devModePanel.js，调整dev-mode-quick-access按钮的行为
3. [x] 更新按钮点击事件处理逻辑
4. [x] 更新按钮样式和状态同步
5. [x] 测试统一后的按钮功能
6. [x] 更新相关文档和注释

**测试结果**：✅ 功能完全正常，按钮状态切换正确，面板开关功能正常

2. **性能优化**
   - 进一步优化页面加载速度
   - 添加资源缓存策略
   - 优化图片加载

3. **用户体验改进**
   - 收集用户反馈
   - 优化界面交互细节
   - 改进错误处理

## 已知问题

- 开发者模式下设备建议的toast通知可能无法正常显示（需要进一步调查）
- 某些外部资源在开发者模式下被拦截（预期行为）

## 更新日志

### 更新日志

#### 2025-09-24
- **修复开发者模式面板功能**：
  - 添加开发者模式面板关闭功能（禁用开发者模式）
  - 实现开发者模式面板拖动功能
  - 优化面板用户体验
  - **测试结果**：✅ 功能完全正常，关闭按钮和拖动功能均正常工作

- **统一开发者模式按钮实现**：
  - 将原有的两个独立按钮合并为单一按钮实现
  - 实现智能状态切换：禁用状态下点击启用并打开面板，启用状态下点击切换面板显示
  - 更新按钮样式为灰色主题，保持视觉一致性
  - 移除冗余的`updateDevModeToggleUI()`函数调用
  - **测试结果**：✅ 功能完全正常，按钮状态切换正确，面板开关功能正常

#### 2025-01-15
- 完成所有alert替换为toast通知
- 优化开发者模式核心逻辑
- 修复设备检测功能
- 添加智能线路选择
- **修复线路选择器为空问题**：通过延迟执行`populateLineSelection()`函数解决模块加载时序问题

### 2025-01-14
- 修复移动端导航栏问题
- 修复下载功能
- 改进错误处理机制

### 2025-09-23
- **测试Playwright MCP功能**：
  - 成功启动Playwright代码生成会话
  - 测试了浏览器导航、截图、点击等功能
  - 生成了自动化测试代码并修复语法错误
  - 创建了手动测试文件验证基本功能
  - **测试结果**：MCP功能正常工作，能够生成有效的Playwright测试代码
  - **发现的问题**：生成的代码存在语法错误（截图参数格式问题），需要手动修复
  - **建议**：改进MCP代码生成器的语法检查机制