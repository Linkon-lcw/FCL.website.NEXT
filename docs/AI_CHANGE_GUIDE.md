# AI 更改指南 - FCL 下载站

## 概述

本指南专为AI助手设计，提供在FCL下载站项目中进行代码更改的标准化流程和最佳实践。遵循这些指南可以确保代码质量、功能完整性和项目一致性。

## 更改前准备

### 1. 项目信息收集

**必须阅读的文档：**
1. `README.md` - 了解项目整体架构和最新功能
2. `todo.md` - 查看当前任务状态和已知问题
3. 本指南 - 理解更改流程和规范

**推荐查看的文档：**
- `docs/网页设计指南.md` - 设计原则和UI规范
- `docs/PLAYWRIGHT_GUIDE.md` - 测试框架使用指南
- 相关模块的`.md`文档（如果有）

### 2. 环境检查

**开发环境：**
- 项目使用模块化架构，支持热重载
- Tailwind CSS需要构建：`npm run build`
- 实时更新tailwind CSS: `npm run watch`

## 更改流程

### 第一阶段：问题分析与规划

1. 每次修改前先阅读readme文件，获取关于项目的信息,阅读todo.md，查看是否有这个任务，并且阅读所有相关的代码文件
2. 在确认问题之后先写到todo.md文件里，把之前任务移动已完成任务里，详细介绍问题发生方法、思路，列一个表写要进行的步骤
3. 修改时修复bug的时候先添加超详细日志定位到具体问题行，然后再修改代码并根治问题，避免后续再次出现相同问题
4. 每次修改之后都要更新todo.md文件，更新分布操作
5. 修改结束后更新todo.md文件和项目文档（如果有），并且在readme文件里详细更改项目当前结构，便于下次理解
6. **测试验证**：修改完成后必须进行全面的功能测试
   - ✅ 核心功能验证：确保主要功能正常工作
   - ✅ 边界条件测试：处理异常输入和极限情况
   - ✅ 兼容性测试：**手动**在不同浏览器和设备上验证
   - ✅ 性能影响评估：检查加载时间和内存使用
7. **代码质量**：确保代码符合项目标准
   - ✅ 所有异步操作包含完整的错误处理
   - ✅ 避免内存泄漏（及时清理事件监听器和定时器）
   - ✅ 复杂逻辑添加详细注释说明
   - ✅ 保持代码风格与项目现有代码一致
   - ✅ 遵循模块化原则，最小化模块间依赖
8. **版本管理**：重要修改要做好版本控制
   - ✅ 重大修改前创建备份或功能分支
   - ✅ 避免直接修改正在运行的生产环境
   - ✅ 准备好快速回滚方案以应对紧急情况
9. **性能监控**：持续监控修改对性能的影响
   - ✅ 检查网络请求数量和时间
   - ✅ 验证页面渲染性能没有下降
   - ✅ 确保动画和交互保持流畅
   - ✅ 监控内存使用情况，避免内存泄漏
10. **用户体验**：始终以用户为中心
    - ✅ 确保错误提示清晰友好
    - ✅ 验证所有交互响应及时
    - ✅ 检查可访问性（键盘导航、屏幕阅读器）
    - ✅ 优化移动端触摸体验

### 第二阶段：代码实施

#### 1. 代码更改原则

**模块化原则：**
- 保持单一职责，每个模块只负责一个功能
- 模块间通过清晰API通信
- 最小化模块间依赖
- 保持向后兼容性

**代码质量标准：**
- 所有异步操作必须包含错误处理
- 避免不必要的DOM操作和重排重绘
- 及时清理事件监听器和定时器
- 复杂逻辑必须添加详细注释

#### 2. 更改实施步骤

**步骤1：创建备份**
```javascript
// 在修改前备份关键文件
// 使用版本控制或手动备份
```

**步骤2：添加详细日志**
```javascript
// 在关键位置添加调试日志
console.log('[模块名] 函数名 - 参数:', params);
console.log('[模块名] 当前状态:', state);
console.error('[模块名] 错误详情:', error);
```

**步骤3：逐步修改**
```javascript
// 1. 先修改核心逻辑
// 2. 更新相关依赖
// 3. 调整UI界面（如果需要）
// 4. 优化性能和体验
```

**步骤4：实时验证**
```javascript
// 每步修改后立即测试
// 检查控制台错误
// 验证功能完整性
// 确认性能影响
```

### 第三阶段：测试验证

#### 1. 功能测试

**基本功能测试：**
```javascript
// 测试修改的核心功能
// 验证相关功能是否受影响
// 检查边界条件处理
// 确认错误处理机制
```

**兼容性测试：**
```javascript
// 桌面端：Chrome, Firefox, Safari, Edge
// 移动端：iOS Safari, Chrome Android
// 不同屏幕尺寸适配
// 触摸和鼠标交互测试
```

#### 2. 性能测试

**加载性能：**
```javascript
// 检查网络请求数量
// 验证资源加载时间
// 确认内存使用情况
// 测试首屏渲染时间
```

**运行时性能：**
```javascript
// 监控CPU使用率
// 检查内存泄漏
// 验证动画流畅度
// 测试响应速度
```


### 第四阶段：文档更新

#### 1. 代码文档

**函数注释：**
```javascript
/**
 * 函数描述
 * @param {类型} paramName - 参数说明
 * @returns {类型} 返回值说明
 * @throws {错误类型} 错误说明
 * @example 使用示例
 */
```

**模块文档：**
```javascript
/**
 * 模块名称
 * 
 * 功能描述
 * 
 * @exports 导出内容
 * @requires 依赖模块
 * @version 版本信息
 * @author 作者信息
 */
```

#### 2. 项目文档更新

**必须更新的文档：**
1. `todo.md` - 更新任务状态
2. `README.md` - 更新项目结构和最新功能
3. 相关模块文档（如果有）

**文档更新内容：**
```markdown
### 更改日期 - 功能名称

**更改内容：**
- 详细描述更改的功能
- 列出关键改进点
- 说明技术实现细节

**解决的问题：**
- 列出修复的具体问题
- 说明问题根本原因
- 描述解决方案思路

**测试结果：**
- ✅ 功能测试通过
- ✅ 兼容性测试通过  
- ✅ 性能测试通过
- ✅ 自动化测试通过
```

## 特殊场景处理

### 1. Bug修复流程

#### 高优先级Bug（影响核心功能）
```
1. 立即创建问题分支
2. 添加详细的错误日志
3. 快速定位问题代码
4. 实施最小化修复
5. 全面测试验证
7. 更新版本号
```

#### 中低优先级Bug
```
1. 在todo.md中记录问题
2. 分析问题影响范围
3. 制定修复计划
4. 按照标准流程实施
5. 验证修复效果
6. 更新相关文档
```

### 2. 性能优化流程

#### 性能问题识别
```
1. 使用浏览器DevTools分析
2. 监控Core Web Vitals指标
3. 检查网络请求和资源加载
4. 分析JavaScript执行性能
5. 识别性能瓶颈
```

#### 优化实施
```
1. 制定优化方案
2. 实施渐进式优化
3. 对比优化前后性能
4. 确保功能不受影响
5. 验证用户体验改善
```

### 3. 兼容性处理

#### 浏览器兼容性
```
1. 检查Can I Use数据库
2. 使用Polyfill处理新API
3. 添加浏览器前缀
4. 测试降级方案
5. 提供替代实现
```

#### 设备兼容性
```
1. 测试不同屏幕尺寸
2. 验证触摸交互
3. 检查性能表现
4. 优化加载策略
5. 处理设备特定问题
```

## 常见陷阱与避免方法

### 1. 时序问题

**问题：** 模块加载顺序导致功能异常
```javascript
// 错误示例
DOMContentLoaded事件中访问异步加载的模块元素

// 正确做法
使用延迟执行或Promise确保模块加载完成
监听自定义事件或回调函数
```

**解决方案：**
```javascript
// 延迟执行
setTimeout(() => {
    // 等待模块加载完成
}, 500);

// Promise方式
await loadModule('moduleName');
// 继续执行依赖代码
```

### 2. 事件监听器泄漏

**问题：** 重复添加事件监听器导致性能问题
```javascript
// 错误示例
element.addEventListener('click', handler);
// 每次加载都添加，导致重复

// 正确做法
// 先移除再添加，或使用once选项
element.removeEventListener('click', handler);
element.addEventListener('click', handler);
```

### 3. 样式冲突

**问题：** Tailwind类名冲突或覆盖
```javascript
// 解决方案
// 1. 使用important修饰符
class="!text-red-500"

// 2. 使用自定义类名
class="custom-class"
// 在CSS中定义具体样式

// 3. 使用内联样式处理特殊情况
style="color: red !important"
```

### 4. 异步错误处理

**问题：** Promise错误未被捕获
```javascript
// 错误示例
fetch(url).then(response => {
    // 处理响应
}); // 没有catch，错误会被静默处理

// 正确做法
fetch(url)
    .then(response => {
        // 处理响应
    })
    .catch(error => {
        console.error('请求失败:', error);
        // 用户友好的错误提示
    });
```

## 最佳实践总结

### 1. 开发原则
- **渐进增强**：从基础功能开始，逐步添加增强功能
- **优雅降级**：确保在不支持的环境中也能正常工作
- **用户优先**：始终考虑用户体验和可访问性
- **性能意识**：每个更改都要考虑性能影响

### 2. 代码质量
- **可读性优先**：代码是写给人看的，机器只是顺便执行
- **适度注释**：解释为什么，而不是做什么
- **一致性**：遵循项目已有的代码风格
- **测试覆盖**：关键功能必须有测试保障

### 3. 项目管理
- **小步快跑**：频繁的小更新比大更新更安全
- **及时沟通**：重要更改要提前沟通
- **文档同步**：代码更改必须同步更新文档
- **版本控制**：合理使用分支和标签

## 结语

遵循本指南可以确保代码更改的质量和一致性。记住：

1. **充分准备**：更改前收集足够信息
2. **循序渐进**：小步快跑，及时验证
3. **全面测试**：不要跳过任何测试环节
4. **及时文档**：更改后立即更新文档
5. **用户优先**：始终考虑最终用户体验

如遇到指南未涵盖的特殊情况，请参考项目历史记录和最佳实践，或寻求团队成员协助。